{% assign ribbon = site.data.ribbon %}
{% assign data = site.data.data %}
{% assign default_section_key = ribbon.default | default: ribbon.sections[0].key %}

{% if ribbon and ribbon.enabled %}
{% comment %} Extract configuration with defaults {% endcomment %}
{% assign style_type = ribbon.style.type | default: 'rounded' %}
{% assign style_size = ribbon.style.size | default: 'sm' %}
{% assign style_alignment = ribbon.style.alignment | default: 'left' %}
{% assign style_shadow = ribbon.style.shadow | default: 'md' %}
{% assign style_bg = ribbon.style.background | default: site.theme_color %}
{% assign style_text = ribbon.style.text | default: '#ffffff' %}
{% assign style_gap = ribbon.style.gap | default: '16px' %}
{% assign style_padding_y = ribbon.style.padding_y | default: '10px' %}
{% assign style_padding_x = ribbon.style.padding_x | default: '0' %}
{% assign mobile_stack = ribbon.responsive.mobile_stack | default: false %}

{% comment %} Build CSS classes {% endcomment %}
{% assign ribbon_classes = 'ribbon-nav shadow-' | append: style_shadow | append: ' style-' | append: style_type %}
{% assign container_classes = 'ribbon-container align-' | append: style_alignment %}
{% if mobile_stack %}
  {% assign container_classes = container_classes | append: ' mobile-stack' %}
{% endif %}

<div class="{{ ribbon_classes }}" style="background: {{ style_bg }}; color: {{ style_text }};">
  <div class="container {{ container_classes }}" style="gap: {{ style_gap }}; padding: {{ style_padding_y }} {{ style_padding_x }};">
    {% for section in ribbon.sections %}
      {% if section.enabled %}
        <button 
          class="btn btn-{{ style_size }} btn-light ribbon-btn" 
          data-target="{{ section.key }}"
          {% if section.description %}
          title="{{ section.description }}"
          aria-label="{{ section.title }}: {{ section.description }}"
          {% else %}
          aria-label="{{ section.title }}"
          {% endif %}>
          {{ section.title }}
        </button>
      {% endif %}
    {% endfor %}
  </div>
</div>

<div id="ribbon-views" class="container" style="padding-top: 16px;" role="main" aria-live="polite">
  {% for section in ribbon.sections %}
    {% if section.enabled %}
      <div class="ribbon-view" id="view-{{ section.key }}" role="tabpanel" aria-labelledby="btn-{{ section.key }}">
        {% case section.type %}
          {% when 'markdown' %}
            <div class="wrapper">
              <section>
                <div class="section-title">{{ section.title }}</div>
                <div class="section-content">
                  <div class="markdown" data-md-src="{{ section.file | relative_url }}"><div class="text-muted">Loading...</div></div>
                </div>
              </section>
            </div>

          {% when 'resume' %}
            <div class="wrapper">
              {% include basic.html %}
              {% include profile.html %}
              {% include areas_of_interest.html %}
              {% include experiences.html %}
              {% include projects.html %}
              {% include publications.html %}
              {% include patents.html %}
              {% include skills.html %}
              {% include education.html %}
              {% include certificates.html %}
              {% include language.html %}
              {% include interests.html %}
              {% include evaluation.html %}
            </div>

          {% when 'downloads' %}
            <div class="wrapper">
              <section>
                <div class="section-title">{{ section.title }}</div>
                <div class="section-content">
                  {% assign download_dir = section.dir | default: '_data/downloadables' %}
                  {% assign files = site.static_files
                    | where_exp: 'f', 'f.relative_path contains download_dir or f.path contains download_dir'
                    | where_exp: 'f', 'f.extname != ".md"' %}
                  <div class="list-group">
                    {% if files.size == 0 %}
                      <div class="text-muted">No downloads available.</div>
                    {% endif %}
                    {% for f in files %}
                      <div class="list-group-item" style="display:flex; align-items:center; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
                        <span>{{ f.name }}</span>
                        <span style="display:flex; gap: 8px;">
                          <a class="btn btn-sm btn-outline-primary" href="{{ f.path | relative_url }}" target="_blank" rel="noopener">Preview</a>
                          <a class="btn btn-sm btn-primary" href="{{ f.path | relative_url }}" download="{{ f.name }}">Download</a>
                        </span>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              </section>
            </div>
        {% endcase %}
      </div>
    {% endif %}
  {% endfor %}
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  (function() {
    'use strict';
    
    // Configuration
    var config = {
      defaultKey: '{{ default_section_key }}',
      baseurl: '{{ site.baseurl | default: "" }}',
      animationEnabled: {{ ribbon.animation.enabled | default: true }},
      animationDuration: {{ ribbon.animation.duration | default: 0.3 }}
    };
    
    // Utility: Try multiple URLs for fetching
    function tryFetch(urls) {
      return new Promise(function(resolve, reject) {
        var i = 0;
        function next() {
          if (i >= urls.length) return reject(new Error('All fetch attempts failed'));
          var u = urls[i++];
          fetch(u).then(function(r){
            if (!r.ok) return next();
            r.text().then(resolve).catch(next);
          }).catch(next);
        }
        next();
      });
    }
    
    // Load markdown content
    function loadMarkdown(container) {
      if (!container || container.getAttribute('data-md-loaded') === 'true') return;
      
      var src = container.getAttribute('data-md-src');
      if (!src) return;
      
      // Show loading state
      container.classList.add('ribbon-loading');
      
      // Build candidate URLs
      var candidates = [src];
      if (config.baseurl && src.indexOf(config.baseurl + '/') === 0) {
        candidates.push(src.substring(config.baseurl.length));
      } else if (config.baseurl) {
        candidates.push(config.baseurl + (src.charAt(0) === '/' ? '' : '/') + src);
      }
      
      tryFetch(candidates).then(function(text){
        try {
          var html = (window.marked && typeof window.marked.parse === 'function') 
            ? window.marked.parse(text) 
            : (window.marked ? window.marked(text) : text);
          container.innerHTML = html;
        } catch (e) {
          container.innerHTML = '<pre>' + text + '</pre>';
        }
        container.classList.remove('ribbon-loading');
        container.setAttribute('data-md-loaded', 'true');
      }).catch(function(err){
        container.classList.remove('ribbon-loading');
        container.innerHTML = '<div class="text-muted">Content unavailable.</div>';
        console.warn('Failed to load markdown:', err);
      });
    }
    
    // Show a specific view
    function showView(key) {
      var views = document.querySelectorAll('.ribbon-view');
      var buttons = document.querySelectorAll('.ribbon-btn');
      
      // Hide all views
      views.forEach(function(v) {
        v.style.display = 'none';
        v.classList.remove('active');
        v.setAttribute('aria-hidden', 'true');
      });
      
      // Show target view
      var target = document.getElementById('view-' + key);
      if (target) {
        target.style.display = '';
        target.classList.add('active');
        target.setAttribute('aria-hidden', 'false');
        
        // Load any markdown in the view
        target.querySelectorAll('[data-md-src]').forEach(loadMarkdown);
        
        // Scroll to top smoothly
        if (window.scrollY > 100) {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      }
      
      // Update button states
      buttons.forEach(function(b) {
        var isActive = b.getAttribute('data-target') === key;
        b.classList.toggle('active', isActive);
        b.setAttribute('aria-pressed', isActive);
      });
      
      // Update URL without page reload
      if (history && history.replaceState) {
        try {
          var url = new URL(window.location.href);
          url.searchParams.set('section', key);
          history.replaceState(null, '', url.toString());
        } catch (e) {
          console.warn('Failed to update URL:', e);
        }
      }
      
      // Announce to screen readers
      var announcement = document.getElementById('ribbon-sr-announcement');
      if (announcement) {
        announcement.textContent = 'Switched to ' + (target ? target.getAttribute('aria-label') || key : key) + ' section';
      }
    }
    
    // Initialize ribbon navigation
    function init() {
      // Add screen reader announcement element
      var announcement = document.createElement('div');
      announcement.id = 'ribbon-sr-announcement';
      announcement.className = 'sr-only';
      announcement.setAttribute('role', 'status');
      announcement.setAttribute('aria-live', 'polite');
      document.body.appendChild(announcement);
      
      // Attach click handlers to buttons
      document.querySelectorAll('.ribbon-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          showView(this.getAttribute('data-target'));
        });
        
        // Add keyboard navigation
        btn.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            this.click();
          }
        });
      });
      
      // Show initial view
      var urlKey = null;
      try {
        urlKey = new URL(window.location.href).searchParams.get('section');
      } catch (e) {
        console.warn('Failed to parse URL:', e);
      }
      showView(urlKey || config.defaultKey);
    }
    
    // Run when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>

{% comment %} Screen reader only class for announcements {% endcomment %}
<style>
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }
</style>
{% endif %}


